<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Mondo Mobile UI — Royal Madison</title>
<style>
  :root{
    --bg:#f7fafc; --panel:#ffffff; --text:#0b1220; --muted:#6b7280; --border:#e5e7eb; --divider:#eef1f5;
    --accent:#0ea05a; --accent-ink:#065f46; --accent-50:#effdf5;
    --blue:#2563eb; --blue-50:#eef2ff;
    --danger:#b91c1c; --danger-light:#ef4444;
    --card-radius:16px; --chip-radius:999px;
    --shadow-1:0 1px 2px rgba(15,23,42,.05), 0 0 0 1px rgba(2,6,23,.02);
    --shadow-2:0 6px 14px rgba(15,23,42,.08), 0 2px 4px rgba(15,23,42,.06);
    font-synthesis-weight:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#f9fbfe 0%,#f6f8fb 100%);color:var(--text);font:16px/1.38 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .app{max-width:430px;margin:0 auto;min-height:100%;display:flex;flex-direction:column}

  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--divider);padding:12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  header .hole{font-weight:900;display:flex;align-items:center;gap:8px;letter-spacing:.2px}
  header .pill{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;display:flex;gap:6px;align-items:center;box-shadow:var(--shadow-1)}
  header .pill strong{color:var(--accent)}
  .toolbar{display:flex;gap:8px;align-items:center}

  .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;letter-spacing:.2px;box-shadow:var(--shadow-1);transition:transform .05s, box-shadow .15s, background .15s}
  .btn:hover{box-shadow:var(--shadow-2)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 14px rgba(14,160,90,.18)}
  .btn.primary:hover{box-shadow:0 10px 22px rgba(14,160,90,.24)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .dots{font-weight:900;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;box-shadow:var(--shadow-1)}
  .select{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;box-shadow:var(--shadow-1);font-weight:800}

  .tabs{position:sticky;top:60px;z-index:8;margin:10px 12px 0;padding:6px;background:#fff;border:1px solid var(--border);border-radius:12px;display:flex;gap:6px;box-shadow:var(--shadow-1)}
  .tab{flex:1;text-align:center;padding:10px 6px;font-weight:900;cursor:pointer;border-radius:10px;color:#111827;background:transparent;transition:background .2s,color .2s}
  .tab.active{color:#fff;background:var(--accent)}
  .tab:not(.active):hover{background:#f3f4f6}

  main{flex:1;display:flex;flex-direction:column}
  .screen{display:none;padding:12px}
  .screen.active{display:block}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--card-radius);padding:12px;margin:12px 0;box-shadow:var(--shadow-1)}
  .row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px dashed var(--divider)}
  .row:last-child{border-bottom:none}
  .id{font-weight:900;letter-spacing:.4px;font-size:1.05rem}
  .hcp{font-size:.83rem;color:#9aa0a6}
  .gross-val{font-weight:900;letter-spacing:.3px}
  .chipbtn{border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:#fff;font-weight:900;box-shadow:var(--shadow-1);cursor:pointer}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--border);padding:8px 12px;border-radius:var(--chip-radius);font-weight:900;cursor:pointer;background:#fff;box-shadow:var(--shadow-1);color:#0b1220}
  .chip:hover{background:#f9fafb}
  /* default active (blue) */
  .chip.active{background:var(--blue-50);border-color:#6366f1;color:#2f3ab2}
  /* manual-active (light grey with black) */
  .chip.manual.active{background:#f3f4f6;border-color:#111827;color:#111827}
  /* for Bally chips we *always* use manual styling when active */
  .chip.bally.active{background:#f3f4f6;border-color:#111827;color:#111827}
  .chip.disabled{opacity:.5;pointer-events:none;text-decoration:line-through}

  .c-grid{display:grid;grid-template-columns:110px 1fr 110px;gap:10px;align-items:flex-start}
  .fixstack{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
  .fixbox{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;border:1px solid var(--border);border-radius:var(--chip-radius);padding:4px 10px;background:#fff;color:#6b7280;box-shadow:var(--shadow-1)}
  .fixbox .box{width:16px;height:16px;border:2px solid #9ca3af;border-radius:4px;display:inline-block;position:relative;background:#fff}
  .fixbox.earned{color:var(--accent-ink);border-color:var(--accent);background:var(--accent-50)}
  .fixbox.earned .box{border-color:var(--accent)}
  .fixbox.earned .box::after{content:'✓';position:absolute;left:1px;top:-3px;font-size:16px;color:var(--accent)}

  .mchecks{display:flex;gap:8px;flex-wrap:wrap}
  .mcheck{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;border:1px solid var(--border);border-radius:var(--chip-radius);padding:6px 12px;background:#fff;color:#0a0a0a;cursor:pointer;box-shadow:var(--shadow-1);font-weight:900}
  .mcheck .box{width:16px;height:16px;border:2px solid #0a0a0a;border-radius:4px;display:inline-block;position:relative;background:#fff}
  .mcheck.active{background:#f3f4f6}
  .mcheck.active .box::after{content:'✓';position:absolute;left:1px;top:-3px;font-size:16px;color:#0a0a0a}
  .mcheck.snake.active{border-color:var(--danger);color:var(--danger)}
  .mcheck.snake.active .box{border-color:var(--danger)}
  .mcheck.snake.active .box::after{color:var(--danger)}
  .mcheck.arnie.auto.active{border-color:var(--blue);color:var(--blue);background:#f0f3ff}
  .mcheck.arnie.auto.active .box{border-color:var(--blue)}
  .mcheck.arnie.auto.active .box::after{color:var(--blue)}
  .mcheck.camel.active{border-color:#b08968;color:#7f5539;background:#fdf5e6}
  .mcheck.camel.active .box{border-color:#7f5539}
  .mcheck.camel.active .box::after{color:#7f5539}
  .mcheck.polie.active{border-color:#7c3aed;color:#5b21b6;background:#f3e8ff}
  .mcheck.polie.active .box{border-color:#5b21b6}
  .mcheck.polie.active .box::after{color:#5b21b6}

  .reason-tag{font-size:.8rem;color:#9ca3af;border:1px dashed #d1d5db;background:#f9fafb;border-radius:var(--chip-radius);padding:4px 10px}
  .bally-won-tag{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;padding:2px 6px;font-size:.75rem;font-weight:900;display:inline-block;margin-top:6px}

  .lb-scroll{overflow-x:auto; overflow-y:auto; max-height:70vh; -webkit-overflow-scrolling:touch; position:relative}
  .lb-card{background:#fff;border:1px solid var(--border);border-radius:var(--card-radius);min-width:420px;box-shadow:var(--shadow-1);position:relative}
  .lb-head, .lb-row{display:grid;grid-template-columns:52px 64px 92px 54px 54px 54px 94px;gap:6px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--divider)}
  .lb-head{background:#f8fafc;font-weight:900;color:#334155 position:sticky; top:0; z-index:6; background:#f8fafc}

  .align-r{text-align:right}
  .place{font-weight:900;color:#334155}
  .lb-foot{margin-top:10px;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:12px;font-size:.92rem;line-height:1.25;box-shadow:var(--shadow-1)}
  .lb-actions{display:flex;gap:8px;margin-top:8px}

  /* Sticky (frozen) first two columns */
  .sticky-col1, .sticky-col2 { position: sticky; z-index: 1; background:#fff; }
  .lb-head .sticky-col1, .lb-head .sticky-col2 { background:#f8fafc; z-index: 2; }
  .sticky-col1 { left: 0; min-width:52px; }
  .sticky-col2 { left: 52px; min-width:64px; }

  .details{margin-top:10px;display:none}
  .details.show{display:block}
  .seg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .seg .btn{padding:8px 12px;font-size:.92rem}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;white-space:pre;display:block;line-height:1.4}
  .skinmark{display:inline-block;min-width:2ch;text-align:right;background:transparent;color:var(--danger-light);font-weight:900}

  footer{position:sticky;bottom:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(120%) blur(8px);border-top:1px solid var(--divider);padding:12px;display:flex;gap:10px}
  .spacer{flex:1}

  .pulse{animation:pulse 1.1s ease-in-out infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(14,160,90,.45)}70%{box-shadow:0 0 0 10px rgba(14,160,90,0)}100%{box-shadow:0 0 0 0 rgba(14,160,90,0)}}
  .small{font-size:.82rem;color:var(--muted)}

  .modal{position:fixed;inset:0;background:rgba(10,15,25,.45);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .sheet{background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;padding:16px 14px 18px;width:100%;max-width:430px;box-shadow:0 -10px 24px rgba(15,23,42,.18)}
  .sheet .title{font-weight:900;font-size:1.02rem;margin-bottom:8px;letter-spacing:.2px}
  .sheet .subtitle{font-size:.95rem;color:#111827;margin-bottom:14px;font-weight:800}
  .sheet .rowline{display:flex;gap:8px;margin-top:12px}
  .sheet .rowline .btn{flex:1}

  #ballyEventName{text-transform:uppercase;letter-spacing:.5px;font-weight:900;color:#334155}
  .no-tiger{background:#fff;border:1px dashed #f59e0b;color:#7c2d12;padding:8px 12px;border-radius:12px;font-weight:900;box-shadow:var(--shadow-1)}

  .keypad{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .key{border:1px solid var(--border);border-radius:12px;padding:14px 0;font-weight:900;background:#fff;box-shadow:var(--shadow-1);cursor:pointer;transition:transform .04s, box-shadow .15s}
  .key:hover{box-shadow:var(--shadow-2)}
  .key:active{transform:translateY(1px)}
  .par-tag{display:inline-block;margin-right:6px;padding:2px 6px;border-radius:6px;background:#ecfeff;color:#0369a1;font-size:.75rem;font-weight:900}
</style>
<link rel="stylesheet" href="spacing-overrides.css">
<style>
/* === Mondo: Sticky Leaderboard Header === */
#leaderboard thead th,
#leaderboardTable thead th,
.leaderboard thead th,
table[data-role="leaderboard"] thead th {
  position: sticky;
  top: 0;
  z-index: 5; /* sit above rows */
  background: #f3f7f0; /* light greenish to match app style; adjust if needed */
}

/* If the table sits in a scrollable pane, ensure the pane can scroll */
#leaderboardContainer, .leaderboard-container {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  max-height: 70vh; /* keeps header visible while the table scrolls */
}
</style></head>
<body>
<div class="app" id="app">
  <header>
    <div class="hole">
      Hole <select id="holeSel" class="select" title="Hole"></select>
    </div>
    <div class="toolbar">
      <select id="groupSel" class="select" title="Group">
        <option value="G1">G1</option><option value="G2">G2</option><option value="G3">G3</option>
        <option value="G4">G4</option><option value="G5">G5</option><option value="G6">G6</option>
      </select>
      <div class="pill"><strong id="par">Par 4</strong> · HCP <span id="hcp">13</span></div>
      <button id="dataBtn" class="dots" title="Data menu">⋯</button>
    </div>
  </header>

  <!-- Start screen -->
  <section id="start" class="screen start-screen">
    <div class="card">
      <div class="start-title" style="font-weight:900;font-size:1.05rem;margin-bottom:2px">Welcome to The Mondo — Royal Madison</div>
      <div class="small" style="margin-bottom:10px">Reload, continue where you left off, or start fresh.</div>
      <div class="start-actions" style="display:grid;gap:8px">
        <button class="btn primary" id="startContinue">Continue where you left off</button>
        <button class="btn" id="startReload">Reload saved tournament data</button>
        <button class="btn" id="startReset">Begin with a reset tournament</button>
        <button class="btn" id="startImport">Import JSON…</button>
        <div class="small" id="startStatus"></div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="page1">Page 1 · Scores</div>
    <div class="tab" data-tab="page2">Page 2 · Carnousties</div>
    <div class="tab" data-tab="page3">Leaderboard</div>
  </div>

  <main>
    <!-- Page 1 -->
    <section id="page1" class="screen active">
      <div class="card" id="playersCard"></div>

      <div class="card" id="ballyCard">
        <div class="row" style="justify-content:flex-start; gap:12px">
          <div style="font-weight:900">Ballybunion</div>
          <div class="small" id="ballyEventName">—</div>
        </div>
        <div class="row" style="border-bottom:none">
          <div class="chips" id="ballyChips"></div>
        </div>
      </div>

      <div class="card" id="tigerCard">
        <div class="row" style="justify-content:flex-start; gap:12px">
          <div style="font-weight:900">Tiger</div>
          <div class="small" id="tigerHelp">LONGEST DRIVE IN THE FAIRWAY</div>
        </div>
        <div class="row" style="border-bottom:none">
          <div class="chips" id="tigerChips"></div>
        </div>
      </div>

      <div id="par3Notice" class="card" style="display:none; padding:10px">
        <div class="no-tiger">NO TIGER AWARDED ON PAR THREES.</div>
      </div>

      <div class="card" id="greenieCard">
        <div class="row" style="justify-content:flex-start; gap:12px">
          <div style="font-weight:900">Greenie</div>
          <div class="small">CLOSEST TO THE PIN IN REGULATION</div>
        </div>
        <div class="row" style="border-bottom:none">
          <div class="chips" id="greenieChips"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <div class="small" style="margin:6px 4px 0;flex:1 1 auto">
          Tap a player to enter <strong>Gross</strong>. Pick Bally/Tiger/Greenie; then Carnousties on Page 2.
        </div>
        <button id="clearHoleBtn" class="chip manual">CLEAR HOLE</button>
      </div>
    </section>

    <!-- Page 2 -->
    <section id="page2" class="screen">
      <div class="card">
        <div class="row" style="justify-content:flex-start; gap:12px">
          <div class="small">Check any of: <strong>Arnie*</strong>, <strong>Polie</strong>, <strong>Camel</strong>, <strong>Snake</strong>. (*Arnie may be unavailable if net&gt;par, Tiger, or Greenie on par-3.)</div>
        </div>
        <div class="row head">
          <div class="c-grid" style="width:100%">
            <div class="small" style="font-weight:900;color:#374151">ID · G/N</div>
            <div class="small" style="font-weight:900;color:#374151">Manual Checks</div>
            <div class="small" style="font-weight:900;color:#374151;text-align:right">Earned</div>
          </div>
        </div>
        <div id="cGrid"></div>
      </div>
    </section>

    <!-- Page 3: Leaderboard -->
    <section id="page3" class="screen">
      <div class="lb-scroll">
        <div class="lb-card" id="lbCard">
          <div class="lb-head">
            <div class="sticky-col1">Place</div>
            <div class="sticky-col2">ID</div>
            <div class="align-r">G/N</div><div class="align-r">Bally</div><div class="align-r">Carny</div><div class="align-r">Skins</div><div class="align-r">$ Total</div>
          </div>
          <div id="lbRows"></div>
        </div>
      </div>
      <div class="lb-foot" id="lbFoot"></div>
      <div class="lb-actions">
        <button class="btn" id="lbDetailsBtn">Details ▸</button>
      </div>
      <div class="details" id="lbDetails">
        <div class="seg">
          <button class="btn" id="segScores">Scores</button>
          <button class="btn" id="segBally">Ballybunions</button>
          <div style="flex:1"></div>
          <div class="seg">
            <button class="btn" id="metricGross">Gross</button>
            <button class="btn" id="metricNet">Net</button>
            <button class="btn" id="metricCarny">Carnousties</button>
          </div>
        </div>
        <div id="detailsMode" class="small" style="font-weight:900;margin-bottom:6px"></div>
        <div id="detailsBody"></div>
      </div>
      <div class="small" style="margin-top:8px">If all players are tied with 0 skins, the skins purse is split equally across the field.</div>
    </section>

    <!-- Review -->
    <section id="review" class="screen">
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px">Group Review</div>
        <div class="rev-card">
          <div class="row" style="font-weight:900;background:#f8fafc">
            <div style="width:64px">ID</div><div class="align-r" style="flex:1">Gross/Net</div><div class="align-r" style="width:80px">Bally</div><div class="align-r" style="width:80px">Carny</div>
          </div>
          <div id="revRows"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <button class="btn" id="backBtn">◀ Back</button>
    <div class="spacer"></div>
    <button class="btn primary" id="nextBtn">Next ▶</button>
  </footer>
</div>

<!-- Data menu modal -->
<div class="modal" id="dataModal" aria-hidden="true">
  <div class="sheet">
    <div class="title">Tournament Data</div>
    <div class="rowline">
      <button class="btn" id="exportBtn">Export JSON</button>
      <button class="btn" id="importBtn">Import JSON</button>
    </div>
    <div class="rowline">
      <button class="btn" id="saveNowBtn">Save Now</button>
      <button class="btn" id="clearBtn">Clear Saved</button>
    </div>
    <div class="small" style="margin-top:8px" id="saveInfo">—</div>
    <div class="rowline">
      <button class="btn" id="dataClose">Close</button>
    </div>
    <input id="fileInput" class="file" type="file" accept="application/json" />
  </div>
</div>

<!-- Gross keypad -->
<div class="modal" id="grossModal" aria-hidden="true">
  <div class="sheet">
    <div class="title" id="gmTitle">Hole 1 — Enter Gross</div>
    <div class="subtitle" id="gmSub">Player: —</div>
    <div id="gmStep1"><div class="keypad" id="gmKeys"></div></div>
    <div id="gmStep2" style="display:none">
      <div class="small" style="margin:0 0 10px">Pick 10–19</div>
      <div class="keypad" id="gmKeys2"></div>
    </div>
    <div class="rowline">
      <button class="btn" id="gmCancel">Cancel</button>
      <button class="btn" id="gmBack" style="display:none">Back</button>
    </div>
  </div>
</div>

<!-- Non-par-3 Tiger case (three-choice) -->
<div class="modal" id="arnieModal" aria-hidden="true">
  <div class="sheet">
    <div class="title">Arnie Confirmation</div>
    <div class="small" id="arnieMsg" style="margin-bottom:10px">—</div>
    <div class="rowline">
      <button class="btn" id="arnieOpt1">—</button>
      <button class="btn primary" id="arnieOpt2">—</button>
    </div>
    <div class="rowline">
      <button class="btn" id="arnieOpt3">—</button>
    </div>
  </div>
</div>

<!-- Par-3 (Greenie exists) three-choice -->
<div class="modal" id="par3Modal" aria-hidden="true">
  <div class="sheet">
    <div class="title" id="par3Title">Par-3 Arnie Check</div>
    <div class="small" id="par3Msg" style="margin-bottom:10px">—</div>
    <div class="rowline">
      <button class="btn" id="par3Opt1">—</button>
      <button class="btn primary" id="par3Opt2">—</button>
    </div>
    <div class="rowline">
      <button class="btn" id="par3Opt3">—</button>
    </div>
  </div>
</div>

<!-- Bally #3 edge-case modal -->
<div class="modal" id="ballyEdgeModal" aria-hidden="true">
  <div class="sheet">
    <div class="title">EDGE CASE SCENARIO</div>
    <div class="small" id="ballyEdgeMsg" style="margin-bottom:10px">Did all players really hole out from off the green?</div>
    <div class="rowline">
      <button class="btn" id="ballyEdgeYes">Yes — continue with no Bally</button>
      <button class="btn primary" id="ballyEdgeNo">No — please award the Ballybunion</button>
    </div>
  </div>
</div>

<script>
/* =================== Static Data =================== */
const groups = {
  G1:[{id:'LUF',name:'DAN MALOOF',hcp:4},{id:'DOED',name:'JEFF DOEDEN',hcp:5},{id:'W',name:'BRETT TILLY',hcp:5},{id:'CJC',name:'JIM CARLSON',hcp:6}],
  G2:[{id:'DF',name:'DAVID FLYNN',hcp:-4},{id:'SRZ',name:'MATT SCHREURS',hcp:-3},{id:'BT3',name:'BRAD TILLY',hcp:3},{id:'ICN',name:'ISAAC CAIN',hcp:5}],
  G3:[{id:'3M',name:'PAT MCMENAMIN',hcp:9},{id:'TST',name:'TODD TILLY',hcp:9},{id:'AMB',name:'RICH AMBERG',hcp:11},{id:'SMBA',name:'ADAM SIMMONS',hcp:13}],
  G4:[{id:'DSG',name:'DAVE SEGHETTI',hcp:10},{id:'GET',name:'SEAN GETTINGS',hcp:10},{id:'MSG',name:'MIKE SEGHETTI',hcp:11},{id:'HLZ',name:'TONY HALSEY',hcp:15}],
  G5:[{id:'MEL',name:'ANDY MILLER',hcp:7},{id:'BDD',name:'BRENT DEENER',hcp:7},{id:'ERN',name:'ERIC NIEUKIRK',hcp:7},{id:'TBK',name:'TUCKER KENNEDY',hcp:7}],
  G6:[{id:'JRY',name:'JERRY SWEET',hcp:3},{id:'YCC',name:'YON CHONG',hcp:9},{id:'KNO',name:'KURT NORRIS',hcp:11},{id:'ATR',name:'ANDY TRENT',hcp:15}],
};
const holeMeta = [
  {par:4,hcp:13},{par:5,hcp:1},{par:4,hcp:5},{par:3,hcp:17},
  {par:4,hcp:11},{par:4,hcp:7},{par:3,hcp:3},{par:4,hcp:9},
  {par:4,hcp:15},{par:4,hcp:2},{par:4,hcp:6},{par:4,hcp:10},
  {par:3,hcp:16},{par:4,hcp:8},{par:4,hcp:14},{par:4,hcp:12},
  {par:3,hcp:18},{par:4,hcp:4}
];
const holeBallyEvent = [
  'Closest to the pin in regulation','Longest drive in the fairway','Longest putt made','First to hole out (wait your turn)',
  'Shortest drive','Closest second shot to Manor Parkway','First on the green','Longest putt made or not',
  'Closest drive to #2 green','Last to get ball on the green','Closest fairway-side drive to the road','First to arrive at the 12th tee',
  'Closest to the pin (1st/2nd if off green)','Closest drive to pin (not on green)','Closest to pin in regulation',
  'Longest drive in the fairway (not in trap)','Farthest tee shot from the pin','Longest putt made'
];
const payouts = { lowNet:[170,110,80,60,40,20], bally:[90,50,40,30,20,10], carny:[90,50,40,30,20,10], skins:[90,50,40,30,20,10] };
const groupOrder = ['G1','G2','G3','G4','G5','G6'];

/* ===== Bally rules ===== */
function ballyRuleForHole(h){
  if(h===1)  return {mode:'optional', auto:'greenie', lock:true};
  if(h===2)  return {mode:'optional', auto:'tiger',   lock:true, linkNone:true};
  if(h===3)  return {mode:'conditional3', auto:null};
  if([4,5,7,10,12].includes(h)) return {mode:'mandatory', auto:null};
  if(h===15) return {mode:'optional', auto:'greenie', lock:true};
  if(h===16) return {mode:'optional', auto:'tiger',   lock:true, linkNone:true};
  return {mode:'optional', auto:null};
}

/* =================== App State & Persistence =================== */
let hole = 1;
let currentGroup = 'G1';
const state = {}; // key: `${gid}-H${hole}`
const SAVE_KEY = 'mondoTournament_v12';
let saveTimer = null;

/* Page 2 advance gating */
let page2Ready = false;

function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveTournament, 200); }
function serializeState(){
  const out={};
  for(const k of Object.keys(state)){
    const st=state[k];
    out[k]={
      gross:st.gross,
      bally:st.bally,
      tiger:st.tiger,
      greenie:st.greenie,
      manualTypes:st.manualTypes.map(s=>[...s]),
      autoArnie: st.autoArnie,
      confirmedArnie: st.confirmedArnie
    };
  }
  return out;
}
function snapshot(){ return {version:12, ts:Date.now(), hole, currentGroup, state:serializeState(), groups, holeMeta, payouts}; }
function saveTournament(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(snapshot())); updateSaveInfo(); }catch(e){ console.error(e); } }
function deserializeState(obj){
  for(const k of Object.keys(obj)){
    const st=obj[k];
    state[k]={
      gross:st.gross??[null,null,null,null],
      bally:st.bally,
      tiger:st.tiger,
      greenie:st.greenie,
      manualTypes:(st.manualTypes||[[],[],[],[]]).map(a=>new Set(a)),
      autoArnie: st.autoArnie || [false,false,false,false],
      confirmedArnie: st.confirmedArnie || [false,false,false,false],
      checks:[[],[],[],[]]
    };
  }
}
function loadTournament(){
  const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;
  try{
    const obj=JSON.parse(raw);
    hole = Math.min(18, Math.max(1, obj.hole||1));
    currentGroup = groupOrder.includes(obj.currentGroup)? obj.currentGroup : 'G1';
    Object.keys(state).forEach(k=>delete state[k]);
    deserializeState(obj.state||{});
    recomputeAllChecks();
    renderAll();
    return true;
  }catch{ return false; }
}
function clearSaved(){ localStorage.removeItem(SAVE_KEY); updateSaveInfo(); }
function recomputeAllChecks(){
  const og=currentGroup, oh=hole;
  for(let h=1; h<=18; h++){
    for(const g of groupOrder){
      currentGroup=g; hole=h;
      if(state[`${g}-H${h}`]) updateAutoChecks();
    }
  }
  currentGroup=og; hole=oh;
}

/* =================== DOM Refs =================== */
const parEl = document.getElementById('par');
const hcpEl = document.getElementById('hcp');
const groupSel = document.getElementById('groupSel');
const holeSel = document.getElementById('holeSel');
const playersCard = document.getElementById('playersCard');
const ballyChips = document.getElementById('ballyChips');
const tigerChips = document.getElementById('tigerChips');
const greenieChips = document.getElementById('greenieChips');
const ballyCard = document.getElementById('ballyCard');
const tigerCard = document.getElementById('tigerCard');
const greenieCard = document.getElementById('greenieCard');
const ballyEventName = document.getElementById('ballyEventName');
const par3Notice = document.getElementById('par3Notice');
const cGrid = document.getElementById('cGrid');
const lbRows = document.getElementById('lbRows');
const lbFoot = document.getElementById('lbFoot');
const lbDetailsBtn = document.getElementById('lbDetailsBtn');
const lbDetails = document.getElementById('lbDetails');
const segScores = document.getElementById('segScores');
const segBally = document.getElementById('segBally');
const metricGross = document.getElementById('metricGross');
const metricNet = document.getElementById('metricNet');
const metricCarny = document.getElementById('metricCarny');
const detailsBody = document.getElementById('detailsBody');
const detailsMode = document.getElementById('detailsMode');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');
const dataBtn = document.getElementById('dataBtn');
const dataModal = document.getElementById('dataModal');
const dataClose = document.getElementById('dataClose');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const saveNowBtn = document.getElementById('saveNowBtn');
const clearBtn = document.getElementById('clearBtn');
const fileInput = document.getElementById('fileInput');
const saveInfo = document.getElementById('saveInfo');

const startScreen = document.getElementById('start');
const startContinue = document.getElementById('startContinue');
const startReload = document.getElementById('startReload');
const startReset = document.getElementById('startReset');
const startImport = document.getElementById('startImport');
const startStatus = document.getElementById('startStatus');

const arnieModal = document.getElementById('arnieModal');
const arnieMsg = document.getElementById('arnieMsg');
const arnieOpt1 = document.getElementById('arnieOpt1');
const arnieOpt2 = document.getElementById('arnieOpt2');
const arnieOpt3 = document.getElementById('arnieOpt3');

const par3Modal = document.getElementById('par3Modal');
const par3Msg = document.getElementById('par3Msg');
const par3Opt1 = document.getElementById('par3Opt1');
const par3Opt2 = document.getElementById('par3Opt2');
const par3Opt3 = document.getElementById('par3Opt3');

const ballyEdgeModal = document.getElementById('ballyEdgeModal');
const ballyEdgeYes = document.getElementById('ballyEdgeYes');
const ballyEdgeNo = document.getElementById('ballyEdgeNo');

const clearHoleBtn = document.getElementById('clearHoleBtn');

for(let i=1;i<=18;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; holeSel.appendChild(o); }

/* =================== Helpers =================== */
function keyFor(g=currentGroup,h=hole){ return `${g}-H${h}` }
function currentPlayers(g=currentGroup){ return groups[g] }
function getHoleState(g=currentGroup,h=hole){
  const k=keyFor(g,h);
  if(!state[k]) state[k]={
    gross:[null,null,null,null],
    bally:undefined, tiger:undefined, greenie:undefined,
    manualTypes:[new Set(),new Set(),new Set(),new Set()],
    autoArnie:[false,false,false,false],
    confirmedArnie:[false,false,false,false],
    checks:[[],[],[],[]]
  };
  return state[k];
}
function strokesForHole(hcp, si){
  if(hcp===0) return 0;
  const abs = Math.abs(hcp);
  const base = Math.floor(abs/18);
  const rem  = abs % 18;
  if(hcp > 0){
    return base + ((rem>0 && si <= rem) ? 1 : 0);
  } else {
    const threshold = 19 - rem;
    const extra = (rem>0 && si >= threshold) ? 1 : 0;
    return -(base + extra);
  }
}
function netWord(net, par){
  const d = net - par;
  if (d === 0) return 'par';
  if (d === -1) return 'birdie';
  if (d <= -3) return 'albatross';
  return 'eagle';
}
function ballyLockWarning(){
  const rule = ballyRuleForHole(hole);
  if(rule.auto==='greenie') return 'WARNING! The Ballybunion and Greenie must go to the same player on this hole.';
  if(rule.auto==='tiger')   return 'WARNING! The Ballybunion and Tiger must go to the same player on this hole.';
  return 'WARNING!';
}
function isAutoAward(key, st){
  const rule = ballyRuleForHole(hole);
  if(rule.auto==='greenie' && key==='greenie'){
    return (typeof st.bally==='number') && st.greenie===st.bally;
  }
  if(rule.auto==='tiger' && key==='tiger'){
    return (typeof st.bally==='number') && st.tiger===st.bally;
  }
  return false;
}

/* =================== Header =================== */
function renderHeader(){
  const m=holeMeta[hole-1];
  holeSel.value=String(hole);
  groupSel.value=currentGroup;
  parEl.textContent=`Par ${m.par}`;
  hcpEl.textContent=m.hcp;
  ballyEventName.textContent = holeBallyEvent[hole-1] || '—';
}

/* =================== Page 1 =================== */
function renderPage1(){
  const st=getHoleState();
  const meta=holeMeta[hole-1];
  playersCard.innerHTML='';
  currentPlayers().forEach((p,idx)=>{
    const g=st.gross[idx];
    let gn='—';
    if(Number.isInteger(g)){
      const net = g - strokesForHole(p.hcp, meta.hcp);
      gn = `${g}/${net}`;
    }
    const row=document.createElement('div'); row.className='row';
    row.innerHTML = `
      <div>
        <div class="id">${p.id}</div>
        <div class="hcp">HCP ${p.hcp}</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="gross-val">${gn}</div>
        <button class="chipbtn" data-idx="${idx}">Set</button>
      </div>`;
    row.querySelector('.chipbtn').addEventListener('click',()=>openGrossModal(idx));
    row.addEventListener('click',(e)=>{ if(!e.target.closest('.chipbtn')) openGrossModal(idx); });
    playersCard.appendChild(row);
  });

  buildBallyChips(st);

  const par3 = (meta.par===3);
  tigerCard.style.display = par3? 'none':''; 
  par3Notice.style.display = par3? '' : 'none';
  if(!par3){ buildPickChips(tigerChips, st, 'tiger', {includeNone:true}); } else { st.tiger=undefined; }
  buildPickChips(greenieChips, st, 'greenie', {includeNone:true});
  pulseGuides();
}

function buildPickChips(container, st, key, {includeNone}={}){
  container.innerHTML='';
  const rule = ballyRuleForHole(hole);
  const opts = currentPlayers().map((p,i)=>({label:p.id, idx:i}));
  if(includeNone) opts.push({label:'None', idx:null});

  opts.forEach(opt=>{
    const active = (st[key]===opt.idx);
    const auto = isAutoAward(key, st);
    const isBally = (key==='bally');
    const b=document.createElement('button');
    b.type='button';
    // base class + styling
    let cls = 'chip';
    if(isBally) cls += ' bally';
    if(active){
      if((key==='tiger' || key==='greenie') && auto){
        cls += ' active'; // blue for auto
      }else{
        cls += ' manual active'; // light grey for manual (also for Bally)
      }
    }
    b.className = cls;
    b.textContent=opt.label;

    b.addEventListener('click',()=>{
      if(rule.lock){
        const bIdx = st.bally;
        if(rule.auto==='tiger' && key==='tiger'){
          if(bIdx!==undefined && opt.idx!==bIdx){
            alert(ballyLockWarning());
            return;
          }
        }
        if(rule.auto==='greenie' && key==='greenie'){
          if(bIdx!==undefined && opt.idx!==bIdx){
            alert(ballyLockWarning());
            return;
          }
        }
      }
      st[key]=opt.idx;
      updateAutoChecks(); renderPage1(); scheduleSave();
    });
    container.appendChild(b);
  });
}

/* ===== Bally building ===== */
function buildBallyChips(st){
  const rule = ballyRuleForHole(hole);
  ballyChips.innerHTML='';

  currentPlayers().forEach((p,i)=>{
    const b=document.createElement('button');
    b.type='button'; b.className='chip bally'+(st.bally===i?' manual active':''); b.textContent=p.id;
    b.addEventListener('click',()=> handleBallyPick(i));
    ballyChips.appendChild(b);
  });

  const allowNone = rule.mode!=='mandatory' && (rule.mode==='optional' || rule.mode==='conditional3');
  const noneBtn=document.createElement('button');
  noneBtn.type='button';
  noneBtn.className='chip bally'+(st.bally===null?' manual active':'')+(rule.mode==='mandatory' ? ' disabled' : '');
  noneBtn.textContent='None';
  if(allowNone){
    noneBtn.addEventListener('click',()=> handleBallyPick(null));
  }
  ballyChips.appendChild(noneBtn);

  const note = document.createElement('div');
  note.className='small';
  note.style.marginTop='6px';
  if(rule.mode==='mandatory'){ note.textContent='This hole requires a Ballybunion — pick a player.'; }
  else if(rule.mode==='conditional3'){ note.textContent='This Bally is generally mandatory. Choose “None” only if truly the edge case applies.'; }
  else { note.textContent='This Bally is optional.'; }
  ballyChips.appendChild(note);
}

function handleBallyPick(idx){
  const st=getHoleState();
  const rule = ballyRuleForHole(hole);

  if(idx===null){
    if(rule.mode==='mandatory'){ return; }
    if(rule.mode==='conditional3'){
      openBallyEdgeModal(()=>{
        st.bally = null;
        if(rule.linkNone && rule.auto==='tiger'){ st.tiger = null; }
        scheduleSave(); renderPage1(); updateAutoChecks();
      }, ()=>{});
      return;
    }
  }

  st.bally = idx;

  if(rule.auto==='greenie'){
    st.greenie = idx;
  } else if(rule.auto==='tiger'){
    st.tiger = idx;
  }
  if(rule.linkNone && idx===null){
    st.tiger = null;
  }

  scheduleSave(); renderPage1(); updateAutoChecks();
}

/* Edge-case modal (Hole 3) */
function openBallyEdgeModal(onYes, onNo){
  ballyEdgeModal.classList.add('show'); ballyEdgeModal.setAttribute('aria-hidden','false');
  const cleanup = ()=>{ ballyEdgeModal.classList.remove('show'); ballyEdgeModal.setAttribute('aria-hidden','true'); };
  ballyEdgeYes.onclick = ()=>{ cleanup(); onYes && onYes(); };
  ballyEdgeNo.onclick  = ()=>{ cleanup(); onNo && onNo(); };
}

/* =================== Pulse guides =================== */
function pulseGuides(){
  const st=getHoleState(); const meta=holeMeta[hole-1];
  const allGross = st.gross.every(v=>Number.isInteger(v));
  const needB = (st.bally===undefined);
  const needT = (meta.par!==3) && (st.tiger===undefined);
  const needG = (st.greenie===undefined);
  ballyCard.classList.toggle('pulse', allGross && needB);
  tigerCard.classList.toggle('pulse', allGross && !needB && needT);
  greenieCard.classList.toggle('pulse', allGross && !needB && !needT && needG);
}

/* =================== Keypad =================== */
const modal = document.getElementById('grossModal');
const gmTitle = document.getElementById('gmTitle');
const gmSub = document.getElementById('gmSub');
const gmKeys = document.getElementById('gmKeys');
const gmKeys2 = document.getElementById('gmKeys2');
const gmStep1 = document.getElementById('gmStep1');
const gmStep2 = document.getElementById('gmStep2');
const gmCancel = document.getElementById('gmCancel');
const gmBack = document.getElementById('gmBack');
let modalPlayerIdx = 0;

function openGrossModal(idx){
  modalPlayerIdx = idx;
  const p=currentPlayers()[idx];
  gmTitle.textContent = `Hole ${hole} — Enter Gross`;
  gmSub.textContent = `Player: ${p.id}`;
  buildKeypadStep1(); gmStep1.style.display='block'; gmStep2.style.display='none'; gmBack.style.display='none';
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
}
function closeGrossModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
function buildKeypadStep1(){
  const par = holeMeta[hole-1].par;
  gmKeys.innerHTML='';
  for(let n=1;n<=9;n++){
    const btn=document.createElement('button');
    btn.className='key';
    btn.innerHTML = (n===par? `<span class="par-tag">Par</span>${n}` : `${n}`);
    btn.addEventListener('click', ()=>commitGross(n));
    gmKeys.appendChild(btn);
  }
  const tenp=document.createElement('button'); tenp.className='key'; tenp.textContent='10+';
  tenp.addEventListener('click', ()=>{ gmStep1.style.display='none'; gmStep2.style.display='block'; gmBack.style.display='inline-block'; buildKeypadStep2(); });
  gmKeys.appendChild(tenp);
}
function buildKeypadStep2(){
  gmKeys2.innerHTML='';
  for(let v=10; v<=19; v++){
    const btn=document.createElement('button'); btn.className='key'; btn.textContent=String(v);
    btn.addEventListener('click', ()=>commitGross(v)); gmKeys2.appendChild(btn);
  }
}
gmBack.addEventListener('click', ()=>{ gmStep2.style.display='none'; gmStep1.style.display='block'; gmBack.style.display='none'; });
gmCancel.addEventListener('click', closeGrossModal);

function commitGross(value){
  if(!(value>=1 && value<=19)) return;
  const st=getHoleState();
  st.gross[modalPlayerIdx] = value; updateAutoChecks(); renderPage1(); scheduleSave();
  const nextIdx = st.gross.findIndex((v,i)=>!Number.isInteger(v) && i>modalPlayerIdx);
  const nextIdxWrap = (nextIdx===-1)? st.gross.findIndex(v=>!Number.isInteger(v)) : nextIdx;
  if(nextIdxWrap!==-1){ openGrossModal(nextIdxWrap); } else { closeGrossModal(); pulseGuides(); }
}

/* =================== Auto checks =================== */
function updateAutoChecks(){
  const st=getHoleState(); const meta=holeMeta[hole-1];

  // Fixed earned checks
  currentPlayers().forEach((p,idx)=>{
    st.checks[idx] = st.checks[idx].filter(x=>!['Tiger','Greenie','Birdie'].includes(x.kind));
    if(meta.par!==3 && st.tiger===idx) st.checks[idx].push({kind:'Tiger'});
    if(st.greenie===idx) st.checks[idx].push({kind:'Greenie'});
    const g = st.gross[idx];
    if(Number.isInteger(g)){
      const net = g - strokesForHole(p.hcp,meta.hcp);
      if(net < meta.par) st.checks[idx].push({kind:'Birdie'});
    }
  });

  // System-auto Arnie hints
  const newAuto = [false,false,false,false];

  if(meta.par===3){
    if(st.greenie==null || st.greenie===undefined){
      currentPlayers().forEach((p,idx)=>{
        const g=st.gross[idx]; if(!Number.isInteger(g)) return;
        const net = g - strokesForHole(p.hcp, meta.hcp);
        if(net<=meta.par){ newAuto[idx]=true; }
      });
    } else {
      const gi = st.greenie;
      if(gi!=null){ st.manualTypes[gi].delete('Arnie'); }
    }
  } else {
    if(st.tiger===undefined || st.tiger===null){
      currentPlayers().forEach((p,idx)=>{
        const g=st.gross[idx]; if(!Number.isInteger(g)) return;
        const net = g - strokesForHole(p.hcp, meta.hcp);
        if(net<=meta.par){ newAuto[idx]=true; }
      });
    }
  }

  // Apply auto flags (respect confirmed)
  currentPlayers().forEach((p,idx)=>{
    const mset = st.manualTypes[idx];
    const wasAuto = !!st.autoArnie[idx];
    if(newAuto[idx]){
      mset.add('Arnie');
    } else if(wasAuto && !st.confirmedArnie[idx]){
      mset.delete('Arnie');
    }
  });
  st.autoArnie = newAuto;
}

/* =================== Page 2 =================== */
function renderPage2(){
  const st=getHoleState(); cGrid.innerHTML=''; updateAutoChecks();
  const meta=holeMeta[hole-1]; const par3=(meta.par===3);
  const kinds=['Arnie','Polie','Camel','Snake'];

  currentPlayers().forEach((p,idx)=>{
    const gv=st.gross[idx];
    let gn='—', net=null;
    if(Number.isInteger(gv)){ net = gv - strokesForHole(p.hcp,meta.hcp); gn = `${gv}/${net}`; }

    const hasT = (!par3 && st.tiger===idx);
    const hasG = (st.greenie===idx);
    const hasB = st.checks[idx].some(x=>x.kind==='Birdie');

    let arnieEligible = (net!=null && net <= meta.par && !hasT);
    let arnieReason = (!arnieEligible ? (net!=null && net>meta.par ? 'net over par' : (hasT ? 'tiger' : '')) : '');
    if(par3 && hasG){ arnieEligible=false; arnieReason='greenie'; }

    const mset = st.manualTypes[idx];
    const autoHint = !!st.autoArnie[idx];
    const confirmed = !!st.confirmedArnie[idx];

    if(!arnieEligible && !confirmed){
      if(mset.has('Arnie')){ mset.delete('Arnie'); }
    }

    const mhtml = kinds.map(k=>{
      if(k==='Arnie'){
        const isActive = mset.has('Arnie') || confirmed;
        const autoCls = (autoHint || confirmed) ? 'auto' : '';
        if(!arnieEligible && !confirmed){
          return `<span class="reason-tag">Arnie: ${arnieReason}</span>`;
        }
        return `<button type="button" class="mcheck arnie ${autoCls} ${isActive?'active':''}" data-idx="${idx}" data-kind="Arnie"><span class="box"></span>Arnie</button>`;
      }
      const extraCls = (k==='Snake') ? 'snake' : (k==='Camel') ? 'camel' : (k==='Polie') ? 'polie' : '';
      const act = mset.has(k)?'active':'';
      return `<button type="button" class="mcheck ${extraCls} ${act}" data-idx="${idx}" data-kind="${k}"><span class="box"></span>${k}</button>`;
    }).join('');

    const earned = `
      ${par3? '' : `<span class="fixbox ${hasT?'earned':''}"><span class="box"></span>Tiger</span>`}
      <span class="fixbox ${hasG?'earned':''}"><span class="box"></span>Greenie</span>
      <span class="fixbox ${hasB?'earned':''}"><span class="box"></span>Birdie</span>
    `;

    const ballyNote = (st.bally===idx) ? `<span class="bally-won-tag">Ballybunion Winner</span>` : '';

    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`
      <div class="c-grid" style="width:100%">
        <div>
          <div class="id">${p.id}</div>
          <div class="small">G/N: ${gn}</div>
          <div class="hcp">HCP ${p.hcp}</div>
          ${ballyNote}
        </div>
        <div class="mchecks">${mhtml}</div>
        <div class="fixstack">${earned}</div>
      </div>`;
    cGrid.appendChild(row);
  });

  cGrid.querySelectorAll('.mcheck').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const idx = Number(btn.dataset.idx);
      const k=btn.dataset.kind;
      const st=getHoleState();
      const mset=st.manualTypes[idx];
      const y=window.scrollY;

      const willActivate = !mset.has(k);
      if(willActivate){
        mset.add(k);
        if(k==='Arnie'){ st.autoArnie[idx]=false; st.confirmedArnie[idx]=false; }
      } else {
        mset.delete(k);
        if(k==='Arnie'){ st.autoArnie[idx]=false; st.confirmedArnie[idx]=false; }
      }

      scheduleSave();
      renderPage2();
      window.scrollTo({top:y,behavior:'auto'});
    });
  });
}

/* =================== Leaderboard + Payouts =================== */
const allPlayers = Object.entries(groups).flatMap(([g,arr])=>arr.map((p,idx)=>({gid:g, idx, id:p.id, name:p.name||'', hcp:p.hcp})));

function totalPurse(){
  const sum = a => a.reduce((s,x)=>s+x,0);
  return sum(payouts.lowNet)+sum(payouts.bally)+sum(payouts.carny)+sum(payouts.skins);
}

function aggregateTotals(){
  const totals = new Map();
  allPlayers.forEach(pl=> totals.set(pl.id,{id:pl.id,name:pl.name,hcp:pl.hcp,gross:0,grossHoles:0,net:0,netHoles:0,bally:0,carny:0,skins:0,moneyExact:0}));

  const addCarny=(id,delta)=>{ const t=totals.get(id); t.carny+=delta; };

  for(let h=1;h<=18;h++){
    const meta=holeMeta[h-1];
    const netForHole=[];

    for(const gid of groupOrder){
      const players=groups[gid];
      const st=state[`${gid}-H${h}`]; if(!st) continue;

      players.forEach((p,idx)=>{
        const gv=st.gross[idx];
        if(Number.isInteger(gv)){
          const net = gv - strokesForHole(p.hcp,meta.hcp);
          const t=totals.get(p.id);
          t.gross+=gv; t.grossHoles++;
          t.net+=net;  t.netHoles++;
          netForHole.push({id:p.id, net});
        }

        if(meta.par!==3 && st.tiger===idx) addCarny(p.id,+1);
        if(st.greenie===idx) addCarny(p.id,+1);
        if(Number.isInteger(gv)){
          const net = gv - strokesForHole(p.hcp,meta.hcp);
          if(net < meta.par) addCarny(p.id,+1);
        }
        if(st.manualTypes && st.manualTypes[idx]){
          st.manualTypes[idx].forEach(k=> addCarny(p.id,(k==='Snake')? -1 : +1));
        }
      });

      if(st && st.bally!==undefined && st.bally!==null){
        const w = players[st.bally]; if(w) totals.get(w.id).bally += 1;
      }
    }

    if(netForHole.length>0){
      const minNet = Math.min(...netForHole.map(x=>x.net));
      const lows = netForHole.filter(x=>x.net===minNet);
      if(lows.length===1){ totals.get(lows[0].id).skins += 1; }
    }
  }
  return totals;
}

function payCategoryCents(totals, key, values, ascending=false){
  const arr=[...totals.values()].map(t=>({id:t.id, value:values(t)}));
  arr.sort((a,b)=> ascending ? (a.value-b.value) : (b.value-a.value));
  const pays=payouts[key]; const placeMoney=new Map();
  let i=0, place=0;
  while(i<arr.length && place<pays.length){
    const start=i; const val=arr[i].value; while(i<arr.length && arr[i].value===val) i++; const tied=i-start;
    let pool=0; for(let k=0;k<tied;k++){ const pIdx=place+k; if(pIdx<pays.length) pool+=pays[pIdx]; }
    const eachRaw = pool/tied;
    const each = Math.round(eachRaw*100)/100;
    for(let j=start;j<i;j++){ const id=arr[j].id; placeMoney.set(id,(placeMoney.get(id)||0)+ each); }
    place+=tied;
  }
  placeMoney.forEach((amt,id)=> totals.get(id).moneyExact += amt );
}

function skinsByHoleMap(){
  const m = new Map();
  for(let h=1;h<=18;h++){
    const netForHole=[];
    for(const gid of groupOrder){
      const st=state[`${gid}-H${h}`]; if(!st) continue;
      const players=groups[gid];
      players.forEach((p,idx)=>{
        const gv=st.gross[idx];
        if(Number.isInteger(gv)){
          const meta=holeMeta[h-1];
          const net = gv - strokesForHole(p.hcp, meta.hcp);
          netForHole.push({id:p.id, net});
        }
      });
    }
    if(netForHole.length){
      const minNet=Math.min(...netForHole.map(o=>o.net));
      const lows=netForHole.filter(o=>o.net===minNet);
      m.set(h, lows.length===1 ? lows[0].id : null);
    } else { m.set(h,null); }
  }
  return m;
}

/* ===== Carnoustie grid per-hole (with snake flags) ===== */
function carnyGridWithSnakeFlags(){
  const grid = new Map();
  const snake = new Map();
  allPlayers.forEach(pl=> { grid.set(pl.id, Array(18).fill(0)); snake.set(pl.id, Array(18).fill(false)); });

  for(let h=1; h<=18; h++){
    const meta = holeMeta[h-1];
    for(const gid of groupOrder){
      const st = state[`${gid}-H${h}`];
      if(!st) continue;
      const players = groups[gid];

      players.forEach((p,idx)=>{
        let delta = 0;
        if(meta.par!==3 && st.tiger===idx) delta += 1;
        if(st.greenie===idx) delta += 1;

        const gv = st.gross[idx];
        if(Number.isInteger(gv)){
          const net = gv - strokesForHole(p.hcp, meta.hcp);
          if(net < meta.par) delta += 1;
        }

        let snakeHere = false;
        if(st.manualTypes && st.manualTypes[idx]){
          st.manualTypes[idx].forEach(k => {
            if(k==='Snake'){ delta -= 1; snakeHere = true; }
            else { delta += 1; }
          });
        }

        grid.get(p.id)[h-1] += delta;
        if(snakeHere) snake.get(p.id)[h-1] = true;
      });
    }
  }
  return {grid, snake};
}

function renderLeaderboard(){
  const totals = aggregateTotals();
  payCategoryCents(totals,'lowNet', t=> (t.netHoles>0? t.net : Infinity), true);
  payCategoryCents(totals,'bally', t=> t.bally, false);
  payCategoryCents(totals,'carny', t=> t.carny, false);

  const maxSkins = Math.max(...[...totals.values()].map(t=>t.skins));
  if(maxSkins===0){
    const pool = payouts.skins.reduce((a,b)=>a+b,0);
    const each = Math.round((pool / totals.size)*100)/100;
    totals.forEach(t=>{ t.moneyExact += each; });
  } else {
    payCategoryCents(totals,'skins', t=> t.skins, false);
  }

  const rows=[...totals.values()].sort((a,b)=> (Math.floor(b.moneyExact) - Math.floor(a.moneyExact)) || (a.net - b.net));

  const labeled = [];
  let i = 0;
  while(i < rows.length){
    const start = i;
    const base = Math.floor(rows[i].moneyExact);
    while(i < rows.length && Math.floor(rows[i].moneyExact) === base){ i++; }
    const groupSize = i - start;
    const placeNum = start + 1;
    const label = groupSize > 1 ? `T${placeNum}` : String(placeNum);
    for(let j=start;j<i;j++){
      labeled.push({place: label, ...rows[j], moneyTrunc: base});
    }
  }

  lbRows.innerHTML = labeled.map(r=>{
    const g = r.grossHoles? r.gross : '—';
    const n = r.netHoles? r.net : '—';
    const gn = (g==='—'||n==='—')? '—' : `${g}/${n}`;
    return `<div class="lb-row">
      <div class="place sticky-col1">${r.place}</div>
      <div class="id sticky-col2">${r.id}</div>
      <div class="align-r">${gn}</div>
      <div class="align-r">${r.bally}</div>
      <div class="align-r">${r.carny}</div>
      <div class="align-r">${r.skins}</div>
      <div class="align-r">$${r.moneyTrunc}</div>
    </div>`;
  }).join('');

  const purse = totalPurse();
  const totalPaid = labeled.reduce((s,r)=> s + r.moneyTrunc, 0);
  let trunk = purse - totalPaid; if(trunk < 0) trunk = 0;

  lbFoot.innerHTML = `
    <div><strong>Total purse:</strong> $${purse}</div>
    <div><strong>Paid out (truncated):</strong> $${totalPaid}</div>
    <div><strong>Mondo Trunk:</strong> $${trunk}</div>
    <div><strong>Check (paid + trunk):</strong> $${totalPaid + trunk}</div>
  `;

  if(!lbDetails.dataset.mode){ lbDetails.dataset.mode='scores'; }
  if(!lbDetails.dataset.metric){ lbDetails.dataset.metric='gross'; } // 'gross'|'net'|'carny'
  buildDetails();
}

/* =================== Details =================== */
document.getElementById('lbDetailsBtn').addEventListener('click', ()=>{
  const show = !lbDetails.classList.contains('show');
  lbDetails.classList.toggle('show', show);
  document.getElementById('lbDetailsBtn').textContent = show ? 'Details ▾' : 'Details ▸';
  if(show) buildDetails();
});
segScores.addEventListener('click', ()=>{ lbDetails.dataset.mode='scores'; buildDetails(); });
segBally.addEventListener('click', ()=>{ lbDetails.dataset.mode='bally'; buildDetails(); });

metricGross.addEventListener('click', ()=>{ lbDetails.dataset.metric='gross'; buildDetails(); });
metricNet.addEventListener('click',   ()=>{ lbDetails.dataset.metric='net';   buildDetails(); });
metricCarny.addEventListener('click', ()=>{ lbDetails.dataset.metric='carny'; buildDetails(); });

function pad(str, n){ str=String(str); return (str.length>=n)? str : str + ' '.repeat(n-str.length); }
function lpad(str, n){ str=String(str); return (str.length>=n)? str : ' '.repeat(n-str.length) + str; }

function buildDetails(){
  const mode = lbDetails.dataset.mode || 'scores';
  const metric = lbDetails.dataset.metric || 'gross';
  const body = document.getElementById('detailsBody');
  detailsMode.textContent = (mode==='scores'
    ? `Scores · ${metric.toUpperCase()}`
    : 'Ballybunions — Winners by Hole/Group');
  body.innerHTML='';
  if(mode==='scores') buildDetailsScores(body, metric);
  else buildDetailsBally(body);
}

function buildDetailsScores(body, metric){
  const playersAll = groupOrder.flatMap(g => groups[g].map((p,idx)=>({gid:g, idx, id:p.id, hcp:p.hcp})));
  const header = `ID   H1 H2 H3  H4 H5 H6  H7 H8 H9  OUT 10 11 12  13 14 15  16 17 18  IN   TOT`;
  const lines = [`<span class="mono" style="font-weight:900">${header}</span>`];

  const skinsMap = (metric==='net') ? skinsByHoleMap() : null;
  const carny = (metric==='carny') ? carnyGridWithSnakeFlags() : null;

  playersAll.forEach(pl=>{
    const nums = [];
    for(let h=1; h<=18; h++){
      let v=null, red=false;
      const st = state[`${pl.gid}-H${h}`];
      if(metric==='carny'){
        const arr = carny.grid.get(pl.id);
        const sflags = carny.snake.get(pl.id);
        v = arr ? arr[h-1] : 0;
        red = sflags ? sflags[h-1] : false;
      } else if(st && Number.isInteger(st.gross[pl.idx])){
        const meta=holeMeta[h-1];
        const gross=st.gross[pl.idx];
        const net = gross - strokesForHole(pl.hcp, meta.hcp);
        v = (metric==='gross') ? gross : net;
      } else {
        v = (metric==='carny') ? 0 : null;
      }
      nums.push({v, red});
    }
    const sum = arr=> arr.reduce((s,x)=> s + (x.v==null?0:x.v), 0);
    const out = sum(nums.slice(0,9));
    const inn = sum(nums.slice(9,18));
    const tot = out + inn;

    const a = nums.map((x,i)=>{
      if(metric==='net' && skinsMap && skinsMap.get(i+1)===pl.id && x.v!=null){
        return `<span class="skinmark">${String(x.v)}</span>`;
      }
      if(metric==='carny'){
        const valStr = String(x.v).padStart(2,' ');
        return x.red ? `<span style="color:#b91c1c">${valStr}</span>` : valStr;
      }
      return (x.v==null ? '–' : String(x.v).padStart(2,' '));
    });

    const parts = [
      pad(pl.id,4),
      a.slice(0,3).join(' '), '', a.slice(3,6).join(' '), '', a.slice(6,9).join(' '),
      lpad(out,4),
      a.slice(9,12).join(' '), '', a.slice(12,15).join(' '), '', a.slice(15,18).join(' '),
      lpad(inn,4), lpad(tot,5)
    ];
    const line = `<span class="mono">${parts.join(' ')}</span>`;
    lines.push(line);
  });
  body.innerHTML = lines.join('\n');
}

function buildDetailsBally(body){
  const tbl = document.createElement('div');
  tbl.className='card';
  let html = `<div style="font-weight:900;margin-bottom:6px">Ballybunions — Winners by Hole/Group</div>`;
  html += `<div class="mono small" style="overflow-x:auto">`;
  html += `     | ${groupOrder.map(g=>g.padEnd(4,' ')).join(' ')}\n`;
  html += `-----+--------------------------------\n`;
  for(let h=1; h<=18; h++){
    const rowVals = groupOrder.map(g=>{
      const st=state[`${g}-H${h}`];
      if(!st || st.bally===undefined) return '—  ';
      if(st.bally===null) return '—  ';
      const pl = groups[g][st.bally];
      return (pl? pl.id : '—').padEnd(4,' ');
    }).join(' ');
    const line = String(h).padStart(2,' ') + '  | ' + rowVals;
    html += line + '\n';
  }
  html += `</div>`;
  tbl.innerHTML = html;
  body.appendChild(tbl);
}

/* =================== Review (group-only) =================== */
const revRows = document.getElementById('revRows');
function aggregateTotalsForGroup(gid){
  const players = groups[gid];
  const totals = players.map(p=>({id:p.id,hcp:p.hcp,gross:0,grossHoles:0,net:0,netHoles:0,bally:0,carny:0}));
  for(let h=1; h<=18; h++){
    const st = state[`${gid}-H${h}`]; const meta=holeMeta[h-1]; if(!st) continue;
    players.forEach((p,idx)=>{
      const gv=st.gross[idx];
      if(Number.isInteger(gv)){ const net=gv - strokesForHole(p.hcp,meta.hcp); totals[idx].gross+=gv; totals[idx].grossHoles++; totals[idx].net+=net; totals[idx].netHoles++; }
      if(meta.par!==3 && st.tiger===idx) totals[idx].carny += 1;
      if(st.greenie===idx) totals[idx].carny += 1;
      if(Number.isInteger(gv)){ const net=gv - strokesForHole(p.hcp,meta.hcp); if(net<meta.par) totals[idx].carny += 1; }
      if(st.manualTypes && st.manualTypes[idx]) st.manualTypes[idx].forEach(k=> totals[idx].carny += (k==='Snake')? -1 : +1);
    });
    if(st && st.bally!==undefined && st.bally!==null){ totals[st.bally].bally += 1; }
  }
  return totals;
}
function renderReviewGroupOnly(){
  const gid=currentGroup; const totals=aggregateTotalsForGroup(gid);
  revRows.innerHTML = totals.map(t=>{
    const g = t.grossHoles? t.gross : '—';
    const n = t.netHoles? t.net : '—';
    return `<div class="row">
      <div class="id">${t.id}</div>
      <div class="align-r" style="flex:1">${(g==='—'||n==='—')?'—':`${g}/${n}`}</div>
      <div class="align-r" style="width:80px">${t.bally}</div>
      <div class="align-r" style="width:80px">${t.carny}</div>
    </div>`;
  }).join('');
}

/* =================== Arnie / Par-3 prompt queues =================== */
let arnieQueue = [];
let par3Queue = [];

function showArniePrompt(doneCb){
  const item = arnieQueue[0];
  if(!item){ doneCb(); return; }

  const { idx, id, word, tigerId, holeNum } = item;
  arnieMsg.textContent = `${id} made a ${word} but did not get an Arnie.`;
  arnieOpt1.textContent = `${id} was in the fairway but shorter than ${tigerId}, Continue with no Arnie for ${id}`;
  arnieOpt2.textContent = `${id} was NOT in the fairway, give him an Arnie`;
  arnieOpt3.textContent = `Recheck all scoring for hole #${holeNum}`;

  arnieModal.classList.add('show'); arnieModal.setAttribute('aria-hidden','false');
  const cleanup = ()=>{ arnieModal.classList.remove('show'); arnieModal.setAttribute('aria-hidden','true'); };

  arnieOpt1.onclick = ()=>{ cleanup(); arnieQueue.shift(); if(arnieQueue.length) showArniePrompt(doneCb); else doneCb(); };
  arnieOpt2.onclick = ()=>{
    const st=getHoleState();
    st.manualTypes[idx].add('Arnie');
    st.autoArnie[idx]=true;
    st.confirmedArnie[idx]=true;
    scheduleSave(); cleanup(); arnieQueue.shift(); renderPage2(); if(arnieQueue.length) showArniePrompt(doneCb); else doneCb();
  };
  arnieOpt3.onclick = ()=>{ cleanup(); arnieQueue=[]; par3Queue=[]; switchTab('page1'); renderPage1(); };
}

function showPar3Prompt(doneCb){
  const item = par3Queue[0];
  if(!item){ doneCb(); return; }
  const {idx, id, word, greenieId, holeNum} = item;

  par3Msg.textContent = `${id} made a ${word} but did not get an Arnie.`;
  par3Opt1.textContent = `${id} was on the green but further from the pin than ${greenieId}, Continue with no Arnie for ${id}`;
  par3Opt2.textContent = `${id} was NOT on the green, give him an Arnie`;
  par3Opt3.textContent = `Recheck all scoring for hole #${holeNum}`;

  par3Modal.classList.add('show'); par3Modal.setAttribute('aria-hidden','false');
  const cleanup = ()=>{ par3Modal.classList.remove('show'); par3Modal.setAttribute('aria-hidden','true'); };

  par3Opt1.onclick = ()=>{ cleanup(); par3Queue.shift(); if(par3Queue.length) showPar3Prompt(doneCb); else doneCb(); };
  par3Opt2.onclick = ()=>{
    const st=getHoleState();
    st.manualTypes[idx].add('Arnie');
    st.autoArnie[idx]=true;
    st.confirmedArnie[idx]=true;
    scheduleSave(); cleanup(); par3Queue.shift(); renderPage2(); if(par3Queue.length) showPar3Prompt(doneCb); else doneCb();
  };
  par3Opt3.onclick = ()=>{ cleanup(); arnieQueue=[]; par3Queue=[]; switchTab('page1'); renderPage1(); };
}

/* Build queues at Next tap on Page 2 */
function buildQueuesForAdvance(){
  arnieQueue = [];
  par3Queue = [];
  const gid=currentGroup, h=hole, st=getHoleState(gid,h), meta=holeMeta[h-1], par3=(meta.par===3);
  const players=currentPlayers(gid);
  const netAt = idx => {
    const g = st.gross[idx];
    if(!Number.isInteger(g)) return null;
    return g - strokesForHole(players[idx].hcp, meta.hcp);
  };

  if(par3){
    if(st.greenie==null || st.greenie===undefined){
      return;
    } else {
      const greenieId = players[st.greenie].id;
      for(let idx=0; idx<players.length; idx++){
        if(idx===st.greenie) continue;
        const net = netAt(idx); if(net==null) continue;
        const hasArnie = st.manualTypes[idx].has('Arnie') || st.confirmedArnie[idx];
        if(net <= meta.par && !hasArnie){
          const word = netWord(net, meta.par);
          par3Queue.push({idx, id: players[idx].id, word, greenieId, holeNum: h});
        }
      }
    }
  } else {
    const tigerIdx = (typeof st.tiger === 'number') ? st.tiger : null;
    if(tigerIdx!=null){
      const tigerId = players[tigerIdx].id;
      for(let idx=0; idx<players.length; idx++){
        const net = netAt(idx); if(net==null) continue;
        const thisHasTiger = (st.tiger === idx);
        const hasArnie = st.manualTypes[idx].has('Arnie') || st.confirmedArnie[idx];
        if(net <= meta.par && !thisHasTiger && !hasArnie){
          const word = netWord(net, meta.par);
          arnieQueue.push({idx, id: players[idx].id, word, tigerId, holeNum: h});
        }
      }
    }
  }
}

/* =================== Clear Hole (current group + hole) =================== */
clearHoleBtn.addEventListener('click', ()=>{
  if(!confirm('Clear ALL data for this group on this hole (both Pages 1 & 2)?')) return;
  const k = keyFor(currentGroup, hole);
  delete state[k];
  scheduleSave();
  renderAll();
});

/* =================== Navigation helpers =================== */
function nextTarget(){
  const gi = groupOrder.indexOf(currentGroup);
  if(gi < groupOrder.length-1) return {group: groupOrder[gi+1], hole, isFinal:false};
  if(hole < 18) return {group: 'G1', hole: hole+1, isFinal:false};
  return {group: 'G6', hole: 18, isFinal:true};
}
function prevTarget(){
  const gi = groupOrder.indexOf(currentGroup);
  if(gi > 0) return {group: groupOrder[gi-1], hole};
  if(hole > 1) return {group: 'G6', hole: hole-1};
  return null;
}

/* =================== Tabs & Footer =================== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
    page2Ready = false;
    updateFooterForTab();
    if(t.dataset.tab==='page2') renderPage2();
    if(t.dataset.tab==='page3') renderLeaderboard();
    if(t.dataset.tab==='page1') renderPage1();
  });
});
function switchTab(id){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
  const tab = document.querySelector(`.tab[data-tab="${id}"]`); if(tab) tab.classList.add('active');
  document.getElementById(id).classList.add('active');
  page2Ready = false;
  updateFooterForTab();
}

function updateFooterForTab(){
  const active = document.querySelector('.tab.active')?.dataset.tab || 'page1';
  nextBtn.style.display = '';
  backBtn.style.display = '';

  if(active==='page1'){
    backBtn.onclick = ()=>{
      const prev = prevTarget(); if(!prev) return;
      currentGroup = prev.group; hole = prev.hole; renderHeader(); switchTab('page1'); renderPage1(); scheduleSave();
    };
    nextBtn.textContent='Next ▶';
    nextBtn.onclick = ()=>{
      const st=getHoleState(); const meta=holeMeta[hole-1];
      if(!st.gross.every(Number.isInteger)){
        const idx=st.gross.findIndex(v=>!Number.isInteger(v)); if(idx!==-1) openGrossModal(idx);
        return;
      }
      if(st.bally===undefined){ ballyCard.scrollIntoView({behavior:'smooth',block:'center'}); return; }
      if(meta.par!==3 && st.tiger===undefined){ tigerCard.scrollIntoView({behavior:'smooth',block:'center'}); return; }
      if(st.greenie===undefined){ greenieCard.scrollIntoView({behavior:'smooth',block:'center'}); return; }
      switchTab('page2'); renderPage2();
    };
  } else if(active==='page2'){
    const t = nextTarget();
    const setBtnLabel = ()=> nextBtn.textContent = page2Ready ? (t.isFinal ? 'Save & Review ▶' : `Save & Next ▶ (${t.group} · H${t.hole})`) : 'Next ▶';

    backBtn.onclick = ()=>{ switchTab('page1'); renderPage1(); };
    setBtnLabel();

    nextBtn.onclick = ()=>{
      if(!page2Ready){
        buildQueuesForAdvance();
        const afterPrompts = ()=>{ page2Ready = true; renderPage2(); setBtnLabel(); };
        if(par3Queue.length){ showPar3Prompt(()=>{ if(arnieQueue.length){ showArniePrompt(afterPrompts); } else afterPrompts(); }); return; }
        if(arnieQueue.length){ showArniePrompt(afterPrompts); return; }
        afterPrompts();
      } else {
        proceedAfterCarny(t);
      }
    };
  } else if(active==='page3'){
    backBtn.onclick = ()=>{ switchTab('page1'); renderPage1(); };
    nextBtn.style.display = 'none';
  }
}

function proceedAfterCarny(t){
  if(t.isFinal){
    document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
    document.getElementById('review').classList.add('active');
    renderReviewGroupOnly();
    backBtn.onclick = ()=>{ switchTab('page1'); renderPage1(); };
    nextBtn.textContent='Leaderboard ▶';
    nextBtn.onclick = ()=>{ switchTab('page3'); renderLeaderboard(); };
  } else {
    currentGroup = t.group; hole = t.hole; renderHeader(); switchTab('page1'); renderPage1(); scheduleSave();
  }
  page2Ready = false;
}

/* =================== Data menu =================== */
function updateSaveInfo(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ saveInfo.textContent = 'No saved tournament.'; return; }
  try{
    const s = JSON.parse(raw); const d = new Date(s.ts||Date.now());
    saveInfo.textContent = `Saved: ${d.toLocaleString()} · Hole ${s.hole} · ${s.currentGroup}`;
  }catch{ saveInfo.textContent = 'Saved: (unreadable)'; }
}
dataBtn.addEventListener('click', ()=>{ dataModal.classList.add('show'); dataModal.setAttribute('aria-hidden','false'); updateSaveInfo(); });
dataClose.addEventListener('click', ()=>{ dataModal.classList.remove('show'); dataModal.setAttribute('aria-hidden','true'); });
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(snapshot(),null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`mondo_tournament.json`; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2500);
});
importBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      hole = Math.min(18, Math.max(1, obj.hole || 1));
      currentGroup = groupOrder.includes(obj.currentGroup) ? obj.currentGroup : 'G1';
      for(const k of Object.keys(state)) delete state[k];
      deserializeState(obj.state || {});
      recomputeAllChecks();
      renderAll();
      localStorage.setItem(SAVE_KEY, JSON.stringify(snapshot()));
      updateSaveInfo();
      hideStart();
      startStatus.textContent = 'Imported tournament.';
      maybePromptGross();
    }catch(err){ startStatus.textContent = 'Import failed — invalid JSON.'; }
  };
  reader.readAsText(f);
  e.target.value='';
});
saveNowBtn.addEventListener('click', saveTournament);
clearBtn.addEventListener('click', ()=>{ clearSaved(); updateSaveInfo(); });

/* =================== Start screen =================== */
function showStart(){
  let hasSave = false, s = null;
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw){
    try{ s = JSON.parse(raw); hasSave = true; }
    catch{ localStorage.removeItem(SAVE_KEY); hasSave = false; }
  }
  const label = hasSave ? `Continue where you left off (${s.currentGroup} · H${s.hole})` : 'Continue where you left off';
  startContinue.textContent = label;
  startContinue.style.display = hasSave ? '' : 'none';
  startReload.style.display = hasSave ? '' : 'none';
  document.querySelectorAll('.tabs, main, footer').forEach(el=> el.style.display='none');
  startScreen.classList.add('active');
}
function hideStart(){
  startScreen.classList.remove('active');
  document.querySelectorAll('.tabs, main, footer').forEach(el=> el.style.display='');
}
startContinue.addEventListener('click', ()=>{
  const ok = loadTournament();
  startStatus.textContent = ok ? 'Resumed.' : 'No valid save found.';
  if(ok){ hideStart(); maybePromptGross(); }
});
startReload.addEventListener('click', ()=>{
  const ok = loadTournament();
  startStatus.textContent = ok ? 'Loaded saved tournament.' : 'No valid save found.';
  if(ok){ hideStart(); maybePromptGross(); }
});
startReset.addEventListener('click', ()=>{
  clearSaved();
  for(const k of Object.keys(state)) delete state[k];
  hole=1; currentGroup='G1';
  renderAll();
  scheduleSave();
  hideStart();
  maybePromptGross();
});
startImport.addEventListener('click', ()=> fileInput.click());

/* =================== Selectors & Init =================== */
groupSel.addEventListener('change',()=>{ currentGroup=groupSel.value; renderAll(); scheduleSave(); });
holeSel.addEventListener('change',()=>{ hole=Number(holeSel.value); renderAll(); scheduleSave(); });

function renderAll(){ renderHeader(); renderPage1(); renderPage2(); renderLeaderboard(); updateFooterForTab(); }
function maybePromptGross(){
  const st = getHoleState();
  const idx = st.gross.findIndex(v => !Number.isInteger(v));
  if (idx !== -1) openGrossModal(idx);
}
function init(){ renderAll(); showStart(); }
init();
</script>

<style>
/* --- Fix sticky header for Leaderboard --- */
.lb-scroll { overflow-y: auto; max-height: 70vh; -webkit-overflow-scrolling: touch; }
.lb-head { position: sticky; top: 0; z-index: 10; background: #fff; }
.lb-head > div { background: inherit; }
/* Ensure header text stays above sticky left columns */
.lb-head .sticky-col1, .lb-head .sticky-col2 { z-index: 11; position: sticky; left: 0; }
.lb-head .sticky-col2 { left: 3.5rem; } /* match body sticky offset for ID col */
</style>
</body>
</html>
